name: build-windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-win:
    name: Build & Release Windows Installer
    runs-on: windows-latest
    env:
      PYTHON_VERSION: '3.11'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version from tag
        id: ver
        shell: pwsh
        run: |
          $v = "${{ github.ref_name }}"
          if ($v -match '^v') { $v = $v.Substring(1) }
          echo "version=$v" >> $env:GITHUB_OUTPUT

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path 'requirements.txt') {
            pip install -r requirements.txt
          }
          # Ensure PyInstaller is available (use project pin if specified in requirements.txt)
          if (-not (pip show pyinstaller)) {
            pip install pyinstaller
          }

      - name: Build application (PyInstaller)
        shell: pwsh
        run: |
          if (Test-Path 'rf2k-trainer.spec') {
            pyinstaller --noconfirm rf2k-trainer.spec
          } else {
            # Fallback: pack main.py as rf2k-trainer.exe
            if (-not (Test-Path 'main.py')) {
              Write-Error "main.py not found and no rf2k-trainer.spec present."
              exit 1
            }
            pyinstaller --noconfirm --onefile --name rf2k-trainer main.py
          }
          if (-not (Test-Path 'dist/rf2k-trainer.exe')) {
            Write-Error "dist\\rf2k-trainer.exe was not produced by PyInstaller."
            exit 1
          }

      - name: Install Inno Setup (ISCC)
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            Write-Error "Could not find ISCC.exe"
            exit 1
          }

      - name: Build installer (Inno Setup)
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path 'rf2k-trainer.iss')) {
            Write-Error "Missing rf2k-trainer.iss in repository root."
            exit 1
          }
          # Pass version from tag to the preprocessor symbol AppVersion
          & $iscc /Qp "/DAppVersion=${{ steps.ver.outputs.version }}" "rf2k-trainer.iss"

      - name: Locate installer
        id: locate
        shell: pwsh
        run: |
          $file = Get-ChildItem -Recurse -File -Filter 'RF2K-TRAINER_*_Setup.exe' | Select-Object -First 1
          if (-not $file) {
            Write-Host "Searching again with wider pattern..."
            $file = Get-ChildItem -Recurse -File -Filter '*Setup*.exe' | Where-Object { $_.Name -match '^RF2K-TRAINER_.*_Setup\.exe$' } | Select-Object -First 1
          }
          if (-not $file) {
            Write-Error "Installer not found. Ensure OutputBaseFilename=RF2K-TRAINER_{#AppVersion}_Setup in rf2k-trainer.iss"
            exit 1
          }
          echo "path=$($file.FullName)" >> $env:GITHUB_OUTPUT
          Write-Host "Installer: $($file.FullName)"

      - name: Upload artifact (for CI debugging)
        uses: actions/upload-artifact@v4
        with:
          name: RF2K-TRAINER-Setup
          path: ${{ steps.locate.outputs.path }}
          if-no-files-found: error
          retention-days: 7

      - name: Create/Update GitHub Release (attach installer only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.locate.outputs.path }}
          generate_release_notes: true

      - name: Prune unwanted assets (raw exe / portable zips)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/','');
            const {data: release} = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner, repo: context.repo.repo, tag
            });
            // Keep only the single Setup.exe matching our naming convention
            const keepRe = /^RF2K-TRAINER_.*_Setup\.exe$/i;
            const remove = release.assets.filter(a =>
              !keepRe.test(a.name) && !/^Source code \(.+\)$/i.test(a.name)
            );
            for (const a of remove) {
              core.info(`Deleting asset: ${a.name}`);
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner, repo: context.repo.repo, asset_id: a.id
              });
            }
